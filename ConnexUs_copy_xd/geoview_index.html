{% extends "base.html" %}
{% block content %}

<div class="container_16">
    <article class="grid_16">
        <div class="item rounded dark">
            <div id="map_canvas" class="map"></div>
            <br />
            <div id="slider"></div>
        </div>
    </article>
</div>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="js/jquery-1.7.1/jquery.min.js"></script>
<!--  <script type="text/javascript" src="js/underscore-1.2.2/underscore.min.js"></script>
<script type="text/javascript" src="js/backbone-0.5.3/backbone.min.js"></script>
<script type="text/javascript" src="js/prettify/prettify.min.js"></script>-->
<script type="text/javascript" src="js/demo.js"></script>
<script type="text/javascript" src="js/markerclustererplus-2.0.6/markerclusterer.min.js"></script>
<script type="text/javascript" src="ui/jquery.ui.map.js"></script>

<!-- <script type="text/javascript" src="js/jquery.js"></script> -->
<script type="text/javascript" src="js/jquery-ui.custom.js"></script>
<script type="text/javascript" src="js/jQDateRangeSlider-min.js"></script>

<script type="text/javascript">
    $(function() {
        demo.add(function() {
            $('#map_canvas').gmap({'zoom': 2, 'disableDefaultUI':true}).bind('init', function(evt, map) {
                var bounds = map.getBounds();
                var southWest = bounds.getSouthWest();
                var northEast = bounds.getNorthEast();
                var lngSpan = northEast.lng() - southWest.lng();
                var latSpan = northEast.lat() - southWest.lat();

                {% for info in infos%}
                    $(this).gmap('addMarker', { 'position': new google.maps.LatLng(southWest.lat() + latSpan * Math.random(), southWest.lng() + lngSpan * Math.random()) } ).click(function() {
                        $('#map_canvas').gmap('openInfoWindow', { content : '<IMG height="100" width="100" src="img?img_id={{ info[0] }}">' }, this);
                    });
                {% endfor%}

                $(this).gmap('set', 'MarkerClusterer', new MarkerClusterer(map, $(this).gmap('get', 'markers')));

            });
        }).load();
    });


    $(function() {
        var today = new Date();
        var todayLastYear = new Date();
        todayLastYear.setFullYear(todayLastYear.getFullYear() - 1);
        $("#slider").dateRangeSlider({
            bounds: {min: todayLastYear, max: today},
            defaultValues: {min: todayLastYear, max: today}
        });

        var from = todayLastYear;
        var to = today;
        $("#slider").on("valuesChanging", function(e, data){
            from = data.values.min;
            to = data.values.max;

            var tmp=$('#map_canvas');

            tmp.gmap('clear','markers');
            tmp.gmap('get','MarkerClusterer').clearMarkers();
            tmp.gmap('closeInfoWindow');
            var map=tmp.gmap('get','map');
            var bounds = map.getBounds();
            var southWest = bounds.getSouthWest();
            var northEast = bounds.getNorthEast();
            var lngSpan = northEast.lng() - southWest.lng();
            var latSpan = northEast.lat() - southWest.lat();

            {% for info in infos%}
                var t = "{{ info[2] }}".split(/[- :]/); // Split timestamp into [ Y, M, D, h, m, s ]
                var info_date = new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5]);  // Apply each element to the Date function
                if (from <= info_date && info_date <= to) {
                    tmp.gmap('addMarker', { 'position': new google.maps.LatLng(southWest.lat() + latSpan * Math.random(), southWest.lng() + lngSpan * Math.random()) }).click(function() {
                        tmp.gmap('openInfoWindow', { content : '<IMG height="100" width="100" src="img?img_id={{ info[0] }}">' }, this);
                    });
                }
            {% endfor%}

            tmp.gmap('set', 'MarkerClusterer', new MarkerClusterer(map, tmp.gmap('get', 'markers')));

        });
    });

</script>


{% endblock %}
